# 🎨 生图助手 (SD-Helper) 用户使用说明

> **版本**: v44.0  
> **作者**: Walkeatround & Gemini & AI Assistant  
> **描述**: SillyTavern 智能生图辅助脚本，支持自动/手动图片生成、AI提示词优化、多种模版配置

---

## 📑 目录

1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [界面说明](#界面说明)
4. [工作模式](#工作模式)
5. [图片UI交互](#图片ui交互)
6. [模版系统](#模版系统)
7. [API配置](#api配置)
8. [高级功能](#高级功能)
9. [常见问题](#常见问题)

---

## 功能概述

生图助手是一个 SillyTavern 增强脚本，主要功能包括：

| 功能 | 描述 |
|------|------|
| **注入模式** | 在AI生成消息时自动注入生图指令，让AI自主插入 `[IMG_GEN]...[/IMG_GEN]` 提示词 |
| **独立生图模式** | 使用独立API分析AI消息并插入图片提示词（不修改酒馆主API设置） |
| **AI修改提示词** | 通过自然语言指令让AI修改/优化现有提示词 |
| **多模版支持** | 提示词模版、独立生词模版、AI修改模版均可自定义 |
| **世界书集成** | 将世界书条目作为参考资料注入AI提示 |
| **顺序/流式生图** | 支持顺序生成和流式实时生成模式 |

---

## 快速开始

### 1. 打开设置面板

在 SillyTavern 右上角扩展菜单中点击「**生图助手**」：

```
┌────────────────────────────────────────┐
│  Extensions Menu                       │
│  ┌────────────────────────────────┐    │
│  │  🖌️ 生图助手            ← 点击  │    │
│  └────────────────────────────────┘    │
│  │  其他扩展...                    │    │
└────────────────────────────────────────┘
```

### 2. 基础配置

1. **启用解析生图**：勾选后脚本将解析 `[IMG_GEN]...[/IMG_GEN]` 标签并生成图片
2. **选择工作模式**：
   - 「启用注入」→ 向酒馆主请求注入模版
   - 「启用独立生图模式」→ 使用独立API分析生成
3. **配置API**：填写 Base URL、API Key、选择模型

### 3. 配置人物特征

切换到「**人物与前后缀**」Tab，添加人物名称和对应的固定特征标签：

```
┌─────────────────────────────────────────────────────────────────┐
│ ☑ │ 小雪      │ 1girl, long white hair, blue eyes, petite      │
├───┼───────────┼─────────────────────────────────────────────────┤
│ ☑ │ 主角      │ 1boy, short black hair, brown eyes, tall       │
├───┼───────────┼─────────────────────────────────────────────────┤
│   │ [+] 添加人物                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. 保存并开始

点击「💾 保存设置」，关闭设置面板，与AI对话即可自动生成图片。

---

## 界面说明

### 设置面板结构

```
┌─────────────────────────────────────────────────────────────────────┐
│              生图助手 v44.0 🎨 设置面板                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────┬────────────┬────────────┬────────────┐             │
│  │  主功能    │ 人物与前后缀 │ 独立生词   │ 自定义模版  │ ← 主Tab导航 │
│  └────────────┴────────────┴────────────┴────────────┘             │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                                                              │  │
│  │                    【Tab内容区域】                            │  │
│  │                                                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌────────────┬────────────┬────────────┬────────────┐             │
│  │ 📤 导出配置 │ 📥 导入配置 │ 🔄 恢复默认 │ 💾 保存设置 │ ← 底部操作栏│
│  └────────────┴────────────┴────────────┴────────────┘             │
└─────────────────────────────────────────────────────────────────────┘
```

### Tab 1: 主功能

```
┌─ 主功能 ────────────────────────────────────────────────────────────┐
│                                                                     │
│  ☑️ 启用解析生图 ▾                                                  │
│  │  └─ 多图生成间隔: [1] 秒                                         │
│  │  └─ 重试次数: [3] 次  重试间隔: [1] 秒                           │
│  │  └─ ☑️ 自动发送生图请求                                          │
│  │  └─ ☐ 启用请求超时 [120] 秒                                      │
│                                                                     │
│  ☐ 启用注入 ▾                                                       │
│  │  └─ 注入深度: [0]   发送角色: [System ▼]                         │
│                                                                     │
│  ☐ 启用独立生图模式 ▾                                               │
│  │  └─ 历史消息数: [4]   防抖延迟: [1000] ms                        │
│                                                                     │
│  ☐ 顺序生图（NAI请开）                                              │
│  ☐ 流式生图                                                        │
│                                                                     │
│  ─────────────── 独立API 配置 ───────────────                       │
│                                                                     │
│  📦 API预设: [默认配置 ▼] [💾 保存] [🗑️]                            │
│  [输入新预设名称（留空则覆盖当前预设）]                              │
│                                                                     │
│  Base URL:   [https://api.deepseek.com          ]                  │
│  API Key:    [sk-**************************     ]                  │
│  模型:       [deepseek-chat ▼] [获取]                               │
│  最大Tokens: [8192]                                                 │
│  温度:       ──────●────── 0.9                                      │
│  Top P:      ────────────● 1.0                                      │
│  Freq Pen:   ●──────────── 0.0                                      │
│  Pres Pen:   ●──────────── 0.0                                      │
│                                                                     │
│  [🧪 测试API连接]                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### Tab 2: 人物与前后缀

```
┌─ 人物与前后缀 ──────────────────────────────────────────────────────┐
│                                                                     │
│  人物列表 [+]                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ ☑ │ 人物名 │ 固定特征标签                          │ [删除] │   │
│  │───┼────────┼───────────────────────────────────────┼────────│   │
│  │ ☑ │ 小雪   │ 1girl, white hair, blue eyes, ...     │ [删除] │   │
│  │ ☑ │ 主角   │ 1boy, black hair, brown eyes, ...     │ [删除] │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ─────────────────────────────────────────────────                  │
│                                                                     │
│  全局前缀:                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ masterpiece, best quality, highly detailed                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  全局后缀:                                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 8k wallpaper, intricate details                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  负面提示词:                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ lowres, bad anatomy, bad hands, worst quality, low quality  │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### Tab 3: 独立生词

```
┌─ 独立生词 ──────────────────────────────────────────────────────────┐
│                                                                     │
│  🔍 过滤标签（上下文过滤）                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ <small>, [statbar], <div>                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│  支持三种格式:                                                      │
│  ① <xxx> 过滤 <xxx>...</xxx>                                       │
│  ② [xxx] 过滤 [xxx]...[/xxx]                                       │
│  ③ 前缀|后缀 过滤自定义前后缀包裹的内容                             │
│                                                                     │
│  📚 世界书注入                                    ☑️ 启用           │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ [🔄 加载角色世界书]                                         │   │
│  │                                                             │   │
│  │ ☑️ 【主世界书】角色设定                                      │   │
│  │   ☑️ 外貌描述                                                │   │
│  │   ☑️ 性格设定                                                │   │
│  │   ☐ 背景故事                                                 │   │
│  │                                                             │   │
│  │ [全选] [全不选] [💾 保存选择]                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  🔍 预览与调试                                                      │
│  [🔄 刷新预览]                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 📋 上下文预览:                                               │   │
│  │ ├─ 最新楼层消息（已编号）: ...                               │   │
│  │ └─ 历史上下文: ...                                           │   │
│  │                                                             │   │
│  │ 📄 完整提示词预览:                                           │   │
│  │ [点击"刷新预览"按钮查看完整提示词]                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### Tab 4: 自定义模版

包含三个子Tab：

```
┌─ 自定义模版 ────────────────────────────────────────────────────────┐
│                                                                     │
│  ┌───────────────┬───────────────┬───────────────┐                 │
│  │ 提示词模版    │ 独立生词模版   │ AI修改模版    │ ← 子Tab导航     │
│  └───────────────┴───────────────┴───────────────┘                 │
│                                                                     │
│  (以下为 独立生词模版 / AI修改模版 编辑器界面)                       │
│                                                                     │
│  ┌──────┬────────────────────────────────────────────────────────┐ │
│  │      │                                                        │ │
│  │ [01] │  标签: [身份定义        ]  角色: [system ▼]            │ │
│  │ [02] │  [⬆️] [⬇️] [🗑️]                                       │ │
│  │ [03] │  ┌──────────────────────────────────────────────────┐ │ │
│  │ [04] │  │ You are an advanced Stable Diffusion prompt     │ │ │
│  │ [05] │  │ generator integrated into an AI roleplay        │ │ │
│  │ ...  │  │ system. Your task is to analyze story content   │ │ │
│  │      │  │ and generate high-quality image prompts.        │ │ │
│  │ [+]  │  └──────────────────────────────────────────────────┘ │ │
│  └──────┴────────────────────────────────────────────────────────┘ │
│                                                                     │
│  💡 可用占位符:                                                     │
│  <!--历史上下文--> → 替换为历史对话内容                             │
│  <!--世界书--> → 替换为世界书参考资料                                │
│  <!--生词模版--> → 替换为当前生词模版                                │
│  <!--当前楼层--> → 替换为最新剧情内容                                │
│                                                                     │
│  [🔄 恢复默认模版]                                                  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 工作模式

### 模式1: 注入模式

**原理**：在酒馆发送请求时，自动将「提示词模版」和「人物特征」注入到发送给AI的消息中，让AI在回复时自行插入 `[IMG_GEN]...[/IMG_GEN]` 标签。

```
用户消息 ────────────────────────────────────────────────────────►
         |
         | 脚本注入模版和人物特征
         ▼
    ┌────────────────────────────────────────────────────────────┐
    │ [System] <IMAGE_PROMPT_TEMPLATE>                           │
    │ You are a Visual Novel Engine...                           │
    │ ## 人物数据库                                               │
    │ - 小雪: 1girl, white hair, blue eyes...                    │
    │ - 主角: 1boy, black hair...                                │
    │ </IMAGE_PROMPT_TEMPLATE>                                   │
    └────────────────────────────────────────────────────────────┘
                         |
                         ▼ 发送给酒馆主API
                    ┌─────────┐
                    │  主API   │
                    └─────────┘
                         |
                         ▼ AI回复带有 [IMG_GEN] 标签
    ┌────────────────────────────────────────────────────────────┐
    │ 小雪微笑着走过来...                                         │
    │ [IMG_GEN]1girl, white hair, blue eyes, smile...[/IMG_GEN]  │
    └────────────────────────────────────────────────────────────┘
                         |
                         ▼ 脚本解析并发送生图请求
                    ┌─────────┐
                    │  SD API  │ (ComfyUI/NAI/WebUI...)
                    └─────────┘
```

**配置要点**：
- 勾选「启用注入」
- 设置注入深度（0=最末尾，数值越大位置越靠前）
- 选择发送角色（System/User/Assistant）

---

### 模式2: 独立生图模式

**原理**：脚本监听AI消息接收完成事件，用独立配置的API分析消息内容，自动插入图片提示词。

```
                    ┌─────────┐
                    │  主API   │ (酒馆设置的API)
                    └─────────┘
                         |
                         ▼ AI回复普通内容
    ┌────────────────────────────────────────────────────────────┐
    │ [P1] 小雪微笑着走过来，轻轻拍了拍我的肩膀。                  │
    │ [P2] "今天天气真好呢！"她望着窗外的阳光说道。               │
    └────────────────────────────────────────────────────────────┘
                         |
                         ▼ 脚本捕获消息，发送给独立API分析
                    ┌─────────┐
                    │ 独立API  │ (生图助手配置的API)
                    └─────────┘
                         |
                         ▼ 返回JSON格式的插入指令
    { "insertions": [
        { "after_paragraph": 1, "prompt": "1girl, white hair..." }
    ] }
                         |
                         ▼ 脚本插入提示词并发送生图请求
    ┌────────────────────────────────────────────────────────────┐
    │ [P1] 小雪微笑着走过来...                                    │
    │ [IMG_GEN]1girl, white hair, blue eyes, smile...[/IMG_GEN]  │
    │ [P2] "今天天气真好呢！"...                                  │
    └────────────────────────────────────────────────────────────┘
```

**配置要点**：
- 勾选「启用独立生图模式」
- 配置独立API（Base URL、API Key、模型）
- 可选：配置世界书注入、过滤标签

**优势**：
- 不影响酒馆主API的设置
- 可以使用更便宜/专用的模型来分析生图
- 支持复杂的模版自定义

---

### 生成触发方式

| 触发方式 | 说明 |
|----------|------|
| **自动触发** | 勾选「自动发送生图请求」后，解析到提示词会自动生图 |
| **手动触发** | 取消勾选后，需点击图片UI右侧区域手动触发 |
| **编辑后手动** | 点击图片UI顶部区域编辑提示词后，点击「生成」按钮 |

---

## 图片UI交互

成功解析到 `[IMG_GEN]...[/IMG_GEN]` 后，会在消息中显示图片UI：

```
┌─────────────────────────────────────────────────────────────────────┐
│                              ▵ (折叠/展开)                          │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  ┌──────────────────────────────────────────────────────┐     │ │
│  │  │                    顶部区域(20%) - 点击编辑提示词     │     │ │
│  │  └──────────────────────────────────────────────────────┘     │ │
│  │                      ┌─────────────────┐                      │ │
│  │                      │                 │                      │ │
│  │  ◄ 上一张            │    生成的图片    │           下一张/生成 ►│ │
│  │     (左20%)          │                 │              (右20%) │ │
│  │                      │                 │                      │ │
│  │                      └─────────────────┘                      │ │
│  │                                                               │ │
│  │  左边底部区域(5%) - 点击删除当前图片                             │ │
│  │                           [1/3]                               │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### 交互区域说明

| 区域 | 位置 | 功能 |
|------|------|------|
| **顶部** | 上方 20% | 点击打开编辑弹窗，可修改提示词或使用AI优化 |
| **左侧** | 左侧 20% | 点击切换到上一张图片（多图时显示） |
| **右侧** | 右侧 20% | 点击切换下一张，或在最后一张时触发重新生成 |
| **底部** | 左下方 5% | 点击删除当前显示的图片 |
| **折叠** | 顶部三角 | 点击折叠/展开图片显示 |

### 编辑弹窗

```
┌─ 编辑提示词 (Block 1) ──────────────────────────────────────────────┐
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 1girl, long white hair, blue eyes, smile, standing,        │   │
│  │ school uniform, classroom, sunlight, masterpiece           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────┐     │
│  │ AI修改指令框 (点击🪄展开)                                  │     │
│  │ [添加更多光影细节]                                         │     │
│  │ [🚀 执行AI更新]                                            │     │
│  └───────────────────────────────────────────────────────────┘     │
│                                                                     │
│  ┌────────────┬────────────┬────────────┐                          │
│  │ 🪄 AI优化   │ ✏️ 仅修改   │ 🎨 生成    │                          │
│  └────────────┴────────────┴────────────┘                          │
└─────────────────────────────────────────────────────────────────────┘
```

| 按钮 | 功能 |
|------|------|
| **🪄 AI优化** | 展开AI修改指令输入框 |
| **✏️ 仅修改** | 保存修改但不触发生成（需手动点击右侧生成） |
| **🎨 生成** | 保存修改并立即发送生图请求 |

---

## 模版系统

### 提示词模版

用于「注入模式」，定义向AI发送的图片生成指令格式。

**特殊占位符**：
- `<!--人物列表-->` → 自动替换为人物列表中已启用的人物及其固定特征

**示例模版**：
```
<IMAGE_PROMPT_TEMPLATE>
You are a Visual Novel Engine. Generate story with image prompts.

## 人物数据库
<!--人物列表-->

## 标签格式
`1girl/1boy, [固定特征], [表情], [服装], [姿势], [视角], [环境]`

## 核心规则
1. 每200-250字插入一个图片提示词
2. 每个提示词只描述一个角色
</IMAGE_PROMPT_TEMPLATE>
```

---

### 独立生词模版

用于「独立生图模式」，定义发送给独立API的完整对话结构。

**可用占位符**：

| 占位符 | 替换内容 |
|--------|----------|
| `<!--历史上下文-->` | 历史对话记录（根据「历史消息数」设置） |
| `<!--世界书-->` | 选中的世界书条目内容 |
| `<!--生词模版-->` | 当前使用的提示词模版 |
| `<!--当前楼层-->` | 最新AI消息内容（已按段落编号） |

**编辑器操作**：

```
左侧面板：消息序号列表         右侧面板：编辑当前消息
┌──────┬─────────────────────────────────────────────────────────┐
│      │                                                         │
│ [01] │  标签: [消息标签]   角色: [system/user/assistant ▼]     │
│ [02] │                                                         │
│ [03] │  [⬆️ 上移] [⬇️ 下移] [🗑️ 删除]                         │
│ ...  │                                                         │
│      │  ┌───────────────────────────────────────────────────┐  │
│ [+]  │  │                                                   │  │
│      │  │              消息内容编辑区                        │  │
│      │  │                                                   │  │
│      │  └───────────────────────────────────────────────────┘  │
└──────┴─────────────────────────────────────────────────────────┘
```

- **点击左侧序号**：切换到对应消息进行编辑
- **点击 [+]**：添加新消息
- **点击 [🔄 恢复默认模版]**：重置为系统默认

---

### AI修改模版

用于「AI优化提示词」功能的对话结构。

**可用占位符**：

| 占位符 | 替换内容 |
|--------|----------|
| `<!--提示词-->` | 当前正在编辑的图片提示词 |
| `<!--修改要求-->` | 用户输入的修改指令 |

---

## API配置

### API预设管理

支持保存多套API配置，方便切换：

```
📦 API预设: [默认配置 ▼] [💾 保存] [🗑️ 删除]
[输入新预设名称（留空则覆盖当前预设）]
```

**操作说明**：
1. **加载预设**：下拉选择后自动加载配置
2. **覆盖保存**：留空名称，点击保存
3. **新建预设**：输入新名称，点击保存
4. **删除预设**：选中后点击删除按钮

### 参数说明

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| **Base URL** | API端点地址 | `https://api.deepseek.com` |
| **API Key** | 授权密钥 | `sk-xxx...` |
| **模型** | 使用的模型 | `deepseek-chat` |
| **最大Tokens** | 最大响应长度 | `4096-8192` |
| **温度** | 创造性（越高越随机） | `0.7-1.0` |
| **Top P** | 核采样（与温度配合） | `0.9-1.0` |
| **Freq Penalty** | 频率惩罚（减少重复） | `0.0-0.5` |
| **Pres Penalty** | 存在惩罚（鼓励新话题） | `0.0-0.5` |

---

## 高级功能

### 顺序生图

勾选「**顺序生图（NAI请开）**」后，多张图片会按顺序逐一生成，避免并发请求导致的报错。

**适用场景**：
- NovelAI 等有并发限制的API
- 网络不稳定环境

### 流式生图

勾选「**流式生图**」后，在酒馆流式生成期间，脚本会实时检测完整的 `[IMG_GEN]` 块并立即发送生图请求，无需等待生成完毕。

**注意**：仅在注入模式下有效。

### 请求超时

勾选「**启用请求超时**」并设置秒数，超时后会自动取消请求并重试。

**适用场景**：
- 生图API偶尔无响应
- 避免永久卡在「请求中」状态

### 世界书注入

在「独立生词」Tab中配置：

1. 点击「**加载角色世界书**」获取当前角色关联的世界书
2. 勾选需要注入的条目
3. 点击「**保存选择**」

选中的条目会作为参考资料发送给AI，帮助其理解人物背景。

### 过滤标签

用于过滤AI消息中不需要分析的部分（如统计框、小字说明等）：

```
<small>, [statbar], <div>, <thought target=|</thought>
```

**格式支持**：
- `<tag>` → 过滤 `<tag>...</tag>`  
- `[tag]` → 过滤 `[tag]...[/tag]`
- `前缀|后缀` → 过滤自定义标记

---

## 常见问题

### Q: 图片没有生成？

1. 检查是否勾选了「启用解析生图」
2. 检查AI回复中是否包含 `[IMG_GEN]...[/IMG_GEN]` 标签
3. 检查酒馆是否正确配置了 Stable Diffusion API
4. 查看浏览器控制台是否有错误信息

### Q: 独立生图模式不工作？

1. 确认勾选了「启用独立生图模式」
2. 确认独立API配置正确（点击「测试API连接」）
3. 检查「独立生词模版」是否正确
4. 点击「刷新预览」查看完整提示词结构

### Q: 人物特征没有被使用？

1. 确认人物名称与AI使用的一致
2. 确认人物行的复选框已勾选
3. 检查模版中是否包含 `<!--人物列表-->` 占位符

### Q: 如何备份/恢复配置？

- **导出**：点击「📤 导出配置」保存为JSON文件
- **导入**：点击「📥 导入配置」选择JSON文件加载

### Q: 切换模版条目时内容被覆盖？

这是一个已知bug，请确保使用最新版本。如仍出现问题，请刷新页面后重试。

---

## 快捷参考

### 生图标签格式

```
[IMG_GEN]1girl, long white hair, blue eyes, smile, standing, 
school uniform, classroom, sunlight, masterpiece, best quality[/IMG_GEN]
```

### 模版占位符速查

| 占位符 | 用途 | 适用模版 |
|--------|------|----------|
| `<!--人物列表-->` | 人物特征库 | 提示词模版 |
| `<!--历史上下文-->` | 历史对话 | 独立生词模版 |
| `<!--世界书-->` | 世界书条目 | 独立生词模版 |
| `<!--生词模版-->` | 提示词模版 | 独立生词模版 |
| `<!--当前楼层-->` | 最新剧情 | 独立生词模版 |
| `<!--提示词-->` | 当前提示词 | AI修改模版 |
| `<!--修改要求-->` | 用户指令 | AI修改模版 |

---

> 💡 **提示**：所有设置修改后请点击「💾 保存设置」，否则关闭弹窗后更改将丢失。
