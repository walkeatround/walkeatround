# 生图助手 使用指南

本文档详细说明生图助手的各项功能操作方法。

---

## 目录

1. [聊天界面 - 图片交互区域](#一聊天界面---图片交互区域)
2. [设置弹窗 - 基础设置Tab](#二设置弹窗---基础设置tab)
3. [设置弹窗 - 人物与模版Tab](#三设置弹窗---人物与模版tab)
4. [设置弹窗 - 前后缀Tab](#四设置弹窗---前后缀tab)
5. [设置弹窗 - 独立生词Tab](#五设置弹窗---独立生词tab)
6. [快捷操作入口](#六快捷操作入口)

---

## 一、聊天界面 - 图片交互区域

每条AI消息中的 `[IMG_GEN]...[/IMG_GEN]` 标签会被渲染成可交互的图片区域：

```
┌─────────────────────────────────────────────┐
│  ▵  ← 点击折叠/展开图片                       │
├─────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────┐ │
│ │ [上方区域 - 点击编辑提示词]              │ │
│ │                                         │ │
│ │ ┌──────┐               ┌──────┐        │ │
│ │ │      │               │      │        │ │
│ │ │ 左侧 │    [图片]     │ 右侧 │        │ │
│ │ │ 区域 │               │ 区域 │        │ │
│ │ │      │               │      │        │ │
│ │ └──────┘               └──────┘        │ │
│ │                                         │ │
│ │      [底部区域 - 点击删除当前图片]       │ │
│ └─────────────────────────────────────────┘ │
│                  1/3                        │ ← 图片序号
└─────────────────────────────────────────────┘
```

### 交互操作说明

| 区域 | 操作 | 功能说明 |
|------|------|----------|
| **▵ 折叠按钮** | 点击 | 折叠/展开图片视图 |
| **上方区域** | 点击 | 打开提示词编辑弹窗，可修改提示词或用AI改写 |
| **左侧区域** | 点击 | 查看上一张历史图片 |
| **右侧区域** | 点击 | 查看下一张历史图片；若已是最新图则生成新图 |
| **底部左侧区域** | 点击 | 删除当前显示的图片 |

### 状态显示

- **"等待生成..."** - 提示词已就绪，等待触发生图
- **"⏳ 请求中..."** - 正在调用API生成图片（蓝色脉冲动画）
- **图片+序号** - 图片已生成，显示当前位置（如"1/3"表示共3张图，当前第1张）

---

## 二、设置弹窗 - 基础设置Tab

打开设置入口：消息编辑菜单（铅笔图标）→ 找到"生图助手"按钮

```
┌──────────────────────────────────────────────────────┐
│  ┌──────────┬──────────────┬────────┬────────────┐   │
│  │ 基础设置 │ 人物与模版   │ 前后缀 │ 独立生词   │   │ ← Tab导航
│  └──────────┴──────────────┴────────┴────────────┘   │
├──────────────────────────────────────────────────────┤
│                                                      │
│  启用生图助手  ☑ ─── 总开关                          │
│                                                      │
│  提示词注入                                           │
│  ├─ 注入开关:  ☑                                    │
│  ├─ 注入深度:  [ 0 ]  ← 0=最后面，1=倒数第一条前...    │
│  └─ 注入角色:  [system ▼] ← system/user/assistant   │
│                                                      │
│  自动刷新                                            │
│  ├─ 刷新开关:  ☐                                    │
│  └─ 刷新间隔:  [ 3000 ] ms                          │
│                                                      │
│  请求超时                                            │
│  ├─ 超时开关:  ☐ ─── 启用后若超时会自动重试          │
│  └─ 超时时间:  [ 120 ] 秒                           │
│                                                      │
│  独立生词模式                                        │
│  ├─ 开关:      ☐ ─── 启用后新回复自动调用独立API    │
│  ├─ 历史数量:  [ 4 ] ─── 注入几条历史消息           │
│  └─ 防抖延迟:  [ 1000 ] ms                          │
│                                                      │
├──────────────────────────────────────────────────────┤
│  API 配置                                            │
│  ├─ Base URL:   [https://api.deepseek.com         ] │
│  ├─ API Key:    [sk-...                            ]│
│  ├─ 模型:       [deepseek-chat ▼] [获取]            │
│  ├─ 最大Tokens: [ 8192 ]                            │
│  ├─ 温度:       ─────●───── 0.9                     │
│  ├─ Top P:      ───────────● 1.0                    │
│  ├─ Freq Penalty: ●──────── 0.0                    │
│  └─ Pres Penalty: ●──────── 0.0                    │
│                                                      │
│  [🧪 测试API连接]                                   │
│                                                      │
├──────────────────────────────────────────────────────┤
│  [📤 导出配置]  [📥 导入配置]  [🔄 恢复默认]        │
│                                                      │
│  [💾 保存设置]                                       │
└──────────────────────────────────────────────────────┘
```

### 关键配置项说明

| 配置项 | 用途 |
|--------|------|
| **提示词注入** | 将生词模版自动注入整体提示词上下文，让AI边写剧情边生成提示词 |
| **自动刷新** | 定时刷新聊天DOM，自动发现并处理新的生图请求 |
| **请求超时** | 图片生成超时后自动重试，避免请求卡住 |
| **独立生词模式** | 启用后，新回复生成后自动调用独立API分析剧情并插入提示词 |
| **API配置** | 用于"AI辅助修图"和"独立生词"功能的LLM API设置 |

---

## 三、设置弹窗 - 人物与模版Tab

```
┌──────────────────────────────────────────────────────┐
│  人物列表                                            │
├──────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────┐  │
│  │ ☑ [角色名称] [特征标签: long hair, red eyes...] [删除] │  │
│  │ ☐ [角色名称] [特征标签: ...]                   [删除] │  │
│  │ ☑ [角色名称] [特征标签: ...]                   [删除] │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  [+ 添加新人物]                                      │
│                                                      │
├──────────────────────────────────────────────────────┤
│  提示词模版                                          │
│  ┌────────────────────────────────────────────────┐  │
│  │  [默认模版 ▼]                                   │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  [✏️ 修改模版]  [🗑️ 删除模版]                       │
│                                                      │
│  ℹ️ 模版中的 <!--人物列表--> 将自动替换为上方启用的人物 │
│                                                      │
│  ┌─ 编辑模版（点击"修改模版"后展开）─────────────────┐ │
│  │ 模版名称: [___________] [替换] [另存]            │ │
│  │                                                  │ │
│  │ ┌──────────────────────────────────────────┐    │ │
│  │ │ <IMAGE_PROMPT_TEMPLATE>                   │    │ │
│  │ │ You are a Visual Novel Engine...          │    │ │
│  │ │ ...                                       │    │ │
│  │ │ </IMAGE_PROMPT_TEMPLATE>                  │    │ │
│  │ └──────────────────────────────────────────┘    │ │
│  │                                                  │ │
│  │ [🤖 使用AI修改]                                  │ │
│  │ [告诉AI如何修改模版...]                          │ │ ← 输入如"添加更多姿势描述"
│  │ [🚀 执行AI修改]                                  │ │
│  └──────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘
```

### 操作说明

1. **添加人物**：点击"+ 添加新人物"，填写角色名和特征标签（如 `long white hair, red eyes, white dress`）
2. **启用人物**：勾选复选框，该人物的特征会被注入到生词模版中
3. **修改模版**：选择模版后点击"修改模版"展开编辑器，可直接编辑或用AI辅助修改
4. **另存模版**：修改后点击"另存"可保存为新模版

---

## 四、设置弹窗 - 前后缀Tab

```
┌──────────────────────────────────────────────────────┐
│  全局前缀                                            │
│  ┌────────────────────────────────────────────────┐  │
│  │ best quality, masterpiece                      │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  全局后缀                                            │
│  ┌────────────────────────────────────────────────┐  │
│  │（可为空）                                      │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  负面提示词                                          │
│  ┌────────────────────────────────────────────────┐  │
│  │ lowres, bad anatomy, bad hands, text, error,  │  │
│  │ missing fingers, extra digit, fewer digits... │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
```

- **全局前缀**：自动添加到每个提示词的开头
- **全局后缀**：自动添加到每个提示词的结尾
- **负面提示词**：用于SD生成时的负面提示词

---

## 五、设置弹窗 - 独立生词Tab

```
┌──────────────────────────────────────────────────────┐
│  🔍 过滤标签（上下文过滤）                           │
│  ┌────────────────────────────────────────────────┐  │
│  │ <small>, [statbar]                             │  │ ← 逗号分隔
│  └────────────────────────────────────────────────┘  │
│  提取上下文时会移除这些标签包裹的内容                 │
│                                                      │
├──────────────────────────────────────────────────────┤
│  📚 世界书注入                         启用 ☑        │
│  选中的条目会作为参考资料发送给AI                     │
│                                                      │
│  [🔄 加载角色世界书]                                 │
│  ┌────────────────────────────────────────────────┐  │
│  │ ☑ [条目名称1] - 世界书A                        │  │
│  │ ☐ [条目名称2] - 世界书A                        │  │
│  │ ☑ [条目名称3] - 世界书B                        │  │
│  │ ...                                            │  │
│  └────────────────────────────────────────────────┘  │
│  [全选]  [全不选]  [💾 保存选择]                     │
│                                                      │
├──────────────────────────────────────────────────────┤
│  上下文预览（最后一次分析）                          │
│  ┌────────────────────────────────────────────────┐  │
│  │ 最新楼层消息（已编号）：                        │  │
│  │ [P1] 她微微一笑，走向窗边...                   │  │
│  │ [P2] "今天天气真好。" 她轻声说道...            │  │
│  │                                                │  │
│  │ 历史上下文：                                   │  │
│  │ [user] 我走进房间...                          │  │
│  │ [assistant] 房间里静悄悄的...                  │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  完整提示词预览                                      │
│  [🔄 刷新预览]                                       │
│  ┌────────────────────────────────────────────────┐  │
│  │ （点击刷新预览查看发送给AI的完整提示词）        │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  [🔄 手动触发独立生图]                               │ ← 对最新AI消息手动重新生词
│                                                      │
│  ▶ 自定义系统提示词 ─── 点击展开                     │
│  ┌────────────────────────────────────────────────┐  │
│  │ （自定义系统提示词，留空使用默认）              │  │
│  │ [恢复默认提示词]  [保存提示词]                  │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
```

### 独立生词工作流程

1. AI生成新回复 → 检测到无生图标签
2. 显示"⏳ 正在调用AI分析..."占位符
3. 独立API分析剧情上下文（世界书+历史消息+最新消息）
4. 返回JSON格式的提示词插入位置
5. 自动将提示词插入到对应段落后并触发生图
6. 不满意可点击"手动触发独立生图"全部重新生成

---

## 六、快捷操作入口

### 消息编辑菜单

点击任意消息的编辑按钮（铅笔图标 ✏️）后，在弹出菜单中可找到：

- **🖼️ 生图助手** - 打开设置弹窗

### 底部操作栏（可在酒馆助手脚本编辑里开关）

部分版本可能在聊天输入框附近显示快捷按钮：

- **SD修复** - 对当前页面上未正确显示的图片框尝试修复
- **手动生词** - 对最新AI消息手动触发一次独立生词流程（会删除最新楼层里已有的图片）

---

## 常见问题

**Q: 图片一直卡在"请求中"怎么办？**  
A: 可能是SD后端未响应。可以尝试：
1. 检查ComfyUI/SD后端是否正常运行
2. 启用"请求超时"功能，超时后会自动重试
3. 点击图片区域右侧（生成新图区域）手动重试

**Q: 独立生词模式不触发？**  
A: 确保：
1. 在"基础设置"Tab中开启了"独立生词模式"开关
2. 已正确配置API URL和API Key
3. 点击"测试API连接"确认连接正常

**Q: 世界书条目不显示？**  
A: 点击"加载角色世界书"按钮后才会显示条目列表。需要当前角色有关联的世界书。
